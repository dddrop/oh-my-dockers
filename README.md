# oh-my-dockers

A powerful CLI tool for managing Docker development environments with automatic reverse proxy configuration, network management, and port conflict detection.

## Features

- ðŸš€ **Local Project Configuration**: Each project has its own `omd.toml` configuration
- ðŸŒ **Network Management**: Automatic Docker network creation and management
- ðŸ”„ **Reverse Proxy**: Automatic HTTPS reverse proxy configuration with Caddy
- ðŸ”Œ **Port Conflict Detection**: Detect and prevent port conflicts across projects
- ðŸ“ **Centralized State**: Project registry stored in `~/.oh-my-dockers`
- ðŸ” **HTTPS Support**: Local SSL certificate support for secure development
- ðŸŽ¯ **Smart Container Discovery**: Automatically parses docker-compose.yml for container info

## Installation

### Prerequisites

- Rust (latest stable version)
- Docker and Docker Compose
- Caddy (for reverse proxy)
- mkcert (for local HTTPS certificates)

### Install mkcert (Required for HTTPS)

mkcert is used to generate locally-trusted SSL certificates for your `.local` domains.

**macOS:**

```bash
brew install mkcert
brew install nss  # Required for Firefox support
```

**Linux (Debian/Ubuntu):**

```bash
sudo apt install libnss3-tools
# Download mkcert from https://github.com/FiloSottile/mkcert/releases
# Or use:
curl -JLO "https://dl.filippo.io/mkcert/latest?for=linux/amd64"
chmod +x mkcert-v*-linux-amd64
sudo mv mkcert-v*-linux-amd64 /usr/local/bin/mkcert
```

**Windows (with Chocolatey):**

```bash
choco install mkcert
```

### Configure mkcert Root CA

**Important**: Run this command once after installing mkcert:

```bash
mkcert -install
```

This installs a local Certificate Authority (CA) in your system trust store. Browsers will trust certificates generated by this CA.

> âš ï¸ **Note**: If you've previously run `mkcert -install` and are experiencing certificate issues, you may need to:
> 1. Uninstall the old CA: `mkcert -uninstall`
> 2. Reinstall mkcert if needed
> 3. Re-run: `mkcert -install`
> 4. Regenerate your project certificates

### Generate Certificates for Your Project

After running `mkcert -install`, generate certificates for your project domains:

```bash
# Navigate to your omd config directory
cd ~/.oh-my-dockers/caddy/certs

# Generate certificate for your project domain
# Example: for a project with domain "my-project.local"
mkcert "my-project.local" "*.my-project.local"

# Rename files to match omd naming convention (replace . with _)
mv my-project.local+1.pem my_project_local.crt
mv my-project.local+1-key.pem my_project_local.key
```

Certificate files should be named:
- Certificate: `{domain_with_underscores}.crt` (e.g., `my_project_local.crt`)
- Private key: `{domain_with_underscores}.key` (e.g., `my_project_local.key`)

### Troubleshooting Certificate Issues

If you encounter certificate errors after installing mkcert:

1. **Verify CA installation:**
   ```bash
   mkcert -CAROOT
   # Check if the directory contains rootCA.pem and rootCA-key.pem
   ```

2. **Restart your browser** after running `mkcert -install`

3. **For Firefox**: Ensure `nss` is installed before running `mkcert -install`

4. **Regenerate certificates** if switching between mkcert installations:
   ```bash
   mkcert -uninstall
   mkcert -install
   # Then regenerate your project certificates
   ```

### Build from Source

```bash
git clone <repository-url>
cd oh-my-dockers
cargo build --release
```

The binary will be available at `target/release/omd`.

### Install to System Path (Optional)

```bash
cargo install --path .
```

## Quick Start

### 1. Navigate to Your Project

```bash
cd /path/to/your/project
```

### 2. Initialize omd Configuration

```bash
omd init
```

This creates an `omd.toml` configuration file with interactive prompts.

### 3. Create Your docker-compose.yml

Create or ensure you have a `docker-compose.yml` file in your project directory. Example:

```yaml
services:
  postgres:
    image: postgres:15
    ports:
      - "5432:5432"
    environment:
      POSTGRES_PASSWORD: secret
    networks:
      - myapp-net

  backend:
    image: myapp-backend
    ports:
      - "3000:3000"
    networks:
      - myapp-net

  frontend:
    image: myapp-frontend
    ports:
      - "8080:80"
    networks:
      - myapp-net

networks:
  myapp-net:
```

### 4. Configure Caddy and Check for Conflicts

```bash
omd project up
```

This will:
- Parse your `docker-compose.yml`
- Check for port conflicts with other registered projects
- Create necessary Docker networks
- **Automatically start Caddy** if not running
- Generate Caddy reverse proxy configuration
- Register the project

### 5. Start Your Services

```bash
docker compose up -d
```

### 6. Access Your Project

Visit `https://your-project.local` (or the domain you configured).

## Configuration

### Configuration Directory

By default, configuration is stored in `~/.oh-my-dockers`. You can customize this by setting the `OH_MY_DOCKERS_DIR` environment variable:

```bash
export OH_MY_DOCKERS_DIR="/custom/path"
```

### Directory Structure

```
~/.oh-my-dockers/
â”œâ”€â”€ config.toml          # Global configuration
â”œâ”€â”€ registry.json        # Project registry with port allocations
â””â”€â”€ caddy/
    â”œâ”€â”€ Caddyfile
    â”œâ”€â”€ certs/           # SSL certificates
    â””â”€â”€ projects/        # Project-specific Caddy configs
```

### Project Configuration (omd.toml)

Each project has an `omd.toml` file in its directory:

```toml
[project]
# Project name (used for container naming)
name = "my-project"

# Domain for this project
domain = "my-project.local"

# Optional: Path to docker-compose file (relative to project directory)
# Defaults to "docker-compose.yml" if not specified
# compose_file = "docker/docker-compose.yml"
# compose_file = "docker-compose.dev.yml"

[network]
# Docker network name for this project
name = "my-project-net"

# Custom Caddy routes (optional)
# If not specified, routes are auto-generated from docker-compose.yml
# Format: subdomain = "container_name:port"
[caddy.routes]
api = "backend-container:3000"
app = "frontend-container:80"
```

## Commands

### Caddy Management

```bash
# Start Caddy (usually auto-started by omd project up)
omd caddy start

# Stop Caddy
omd caddy stop

# Restart Caddy
omd caddy restart

# Show Caddy status
omd caddy status

# Show Caddy logs
omd caddy logs
omd caddy logs --follow  # Follow logs in real-time
```

### Initialize a Project

```bash
cd /path/to/project
omd init
```

Creates an `omd.toml` configuration file with interactive prompts.

### Configure Project

```bash
cd /path/to/project
omd up
```

This command:
1. Reads `omd.toml` and `docker-compose.yml`
2. Checks for port conflicts
3. Creates Docker networks
4. Generates Caddy configuration
5. Registers the project

**Note**: This doesn't start containers, only configures the infrastructure.

### Remove Project Configuration

```bash
cd /path/to/project
omd down
```

Removes Caddy configuration and unregisters the project. Containers remain running.

### List Registered Projects

```bash
omd project list
```

Shows all registered projects with their paths, domains, and port allocations.

### Network Management

```bash
# List all networks
omd network list
```

### Reverse Proxy Management

```bash
# Add a proxy rule
omd proxy add example.com backend:8080

# List all proxy rules
omd proxy list

# Remove a proxy rule
omd proxy remove example.com

# Reload Caddy configuration
omd proxy reload
```

### Port Mapping

```bash
# List all port mappings
omd ports

# Show ports for a specific network
omd ports show my-network
```

## How It Works

### Port Conflict Detection

When you run `omd up`, the tool:

1. Parses your `docker-compose.yml` to extract host port mappings
2. Checks the project registry for conflicts
3. Displays conflicts with project names if found
4. Only proceeds if no conflicts exist

Example output:

```
âœ— Port conflicts detected:
  Port 5432 is already used by project another-project
```

### Automatic Route Generation

If you don't specify custom routes in `omd.toml`, the tool automatically generates Caddy routes based on your `docker-compose.yml`:

- Each service becomes a subdomain: `{service}.{domain}`
- Container names are automatically detected or generated
- Only services with exposed ports get routes

### Custom Routes

You can override automatic routing by specifying routes in `omd.toml`:

```toml
[caddy.routes]
api = "my-backend-container:3000"
app = "my-frontend-container:80"
admin = "my-admin-container:8080"
```

This creates:
- `api.my-project.local` â†’ `my-backend-container:3000`
- `app.my-project.local` â†’ `my-frontend-container:80`
- `admin.my-project.local` â†’ `my-admin-container:8080`

## Workflow Example

```bash
# Create a new project
mkdir my-awesome-app
cd my-awesome-app

# Initialize omd configuration
omd init
# > Project name [my-awesome-app]: 
# > Domain [my-awesome-app.local]: 
# > Network name [my-awesome-app-net]: 

# Create your docker-compose.yml
cat > docker-compose.yml <<EOF
services:
  postgres:
    image: postgres:15
    ports:
      - "5432:5432"
    environment:
      POSTGRES_PASSWORD: secret
    networks:
      - my-awesome-app-net

  backend:
    build: ./backend
    ports:
      - "3000:3000"
    networks:
      - my-awesome-app-net

networks:
  my-awesome-app-net:
EOF

# Configure infrastructure
omd up
# âœ“ No port conflicts
# âœ“ Network created
# âœ“ Caddy configuration generated

# Start services
docker compose up -d

# Check registered projects
omd project list
# â€¢ my-awesome-app
#   Path: /path/to/my-awesome-app
#   Domain: my-awesome-app.local
#   Network: my-awesome-app-net
#   Ports: 5432, 3000
```

## Requirements

- Docker and Docker Compose installed and running
- Caddy container running (for reverse proxy features)
- Rust (for building from source)

## License

[Add your license here]

## Contributing

[Add contribution guidelines here]

## See Also

- [docs/MANUAL.md](docs/MANUAL.md) - Detailed usage manual (English)
- [docs/MANUAL.zh.md](docs/MANUAL.zh.md) - ä½¿ç”¨æ‰‹å†Œï¼ˆä¸­æ–‡ï¼‰
- [docs/MANUAL.ja.md](docs/MANUAL.ja.md) - ãƒžãƒ‹ãƒ¥ã‚¢ãƒ«ï¼ˆæ—¥æœ¬èªžï¼‰
